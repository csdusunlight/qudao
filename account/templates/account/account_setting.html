{% load staticfiles %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>用户中心</title>
<link href="{% static 'images/favicon.ico'%}" rel="shortcut icon"/>
<link rel="stylesheet" type="text/css" href="{% static 'css/wfl-common.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/account-base.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/account_setting.css' %}" />
<link rel="stylesheet" href="{% static 'css/cropbox.css' %}" type="text/css" />
<script type="text/javascript" src="{% static 'js/jquery-1.11.2.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/cropbox.js' %}"></script>
<!--<script type="text/javascript" src="{% static 'js/page.js' %}"></script>-->
<script type="text/javascript">


$(function(){
    $('.back-a2').toggleClass("on");
    $(window).load(function() {
        
    });
});
</script>
</head>

<body>
	{% include "header.html" %}
	<!--内容-->
	<div class="Content">
    	{% include "account/left.html" %}
    	<div class="RightCont">
    	    <div class="right-top clearfix">
    	        <h2 class="top-title l">主页资料</h2>
    	        <a class="btn m-yellow m-exp r" href="/homepage/" target="_blank">参考范例</a>
    	    </div>
    	    <div class="user-info-box">
        	    <div class="item">
        	        <span class="item__name">头像</span>
        	        <!--<div class="img-up">
                        <input type="file" name="picfile" id="choose" accept="image/jpeg,image/png">
                        <ul id="img_list" class="img-list">
                            <li id="userimg" class="userimg"></li>
                        </ul>
                        <a id="upload">更换头像</a>
                    </div>-->
                    <div class="uploadimg-container">
                          <div class="imageBox">
                            <div class="thumbBox"></div>
                            <div class="spinner" style="display: none">Loading...</div>
                          </div>
                          <div class="action">
                            <div class="new-contentarea tc">
                                <a href="javascript:void(0)" class="upload-img">
                                    <label for="upload-file">上传图像</label>
                              </a>
                              <input type="file" class="" name="upload-file" id="upload-file" />
                            </div>
                            <input type="button" id="btnCrop"  class="Btnsty_peyton" value="裁切">
                            <input type="button" id="btnZoomIn" class="Btnsty_peyton" value="+"  >
                            <input type="button" id="btnZoomOut" class="Btnsty_peyton" value="-" >
                          </div>
                          <div class="cropped"></div>
                    </div>
        	    </div>
        	    <div class="item">
                    <span class="item__name">皮肤</span>
                    <ul class="skin">
                    	<li class="skin__item m-01">皮肤1</li>
                    	<li class="skin__item m-02">皮肤2</li>
                    	<li class="skin__item m-03 on">皮肤3</li>
                    	<li class="skin__item m-04">皮肤4</li>
                    	<li class="skin__item m-05">皮肤5</li>
                    	<li class="skin__item m-06">皮肤6</li>
                    </ul>
                </div>
                <div class="item">
                    <span class="item__name m-need">昵称</span>
                    <input class="qqname item__txt" type="text" maxlength="12" />
                    <span>用于显示在个人主页，限12字以内</span>
                </div>
                <div class="item">
                    <span class="item__name m-need">QQ</span>
                    <input class="qq item__txt" type="text" onkeyup="this.value=this.value.replace(/\D/g,'')" />
                </div>
                <div class="item">
                    <span class="item__name">个人签名</span>
                    <input class="tosign item__txt" type="text" />
                </div>
                
                <div class="btnbox">
                    <a class="cancle btn m-yellow">取消</a>
                    <a class="save btn m-green">保存</a>
                </div>
    	    </div>
            
            <div class="notice-info-box">
                <h2 class="notice-title">编辑公告</h2>
                <div class="item">
                    <span class="item__name"></span>
                    <div class="notice-box">
                        <div class="input-box">
                            <input class="item__txt notice" type="text" /><a class="notice-add">添加</a>
                            <span>最多可添加十条公告</span>
                        </div>
                    </div>
                    <p class="notice-exist-title">已有公告:</p>
                    <ul class="notice-exist">
                    	<!--<li>公告111公告111公告111公告111公告111公告111公告111公告111公告111
                    	    <span class="notice-change" onclick="noticeChange(this,1)">修改</span>
                    	    <span class="notice-delete" onclick="noticeDelete(this,1)">删除</span>
                    	</li>
                    	<li>公告222公告222公告222公告222公告222公告222公告222公告222公告222公告222
                    	    <span class="notice-change" onclick="noticeChange(this,1)">修改</span>
                            <span class="notice-delete" onclick="noticeDelete(this,1)">删除</span>
                    	</li>
                    	<li>公告333公告333公告333公告333公告333公告333公告333公告333公告333公告333
                    	    <span class="notice-change" onclick="noticeChange(this,1)">修改</span>
                            <span class="notice-delete" onclick="noticeDelete(this,1)">删除</span>
                    	</li>
                    	<li>公告444公告444公告444公告444公告444公告444公告444公告444公告444公告444
                    	    <span class="notice-change" onclick="noticeChange(this,1)">修改</span>
                            <span class="notice-delete" onclick="noticeDelete(this,1)">删除</span>
                    	</li>-->
                    </ul>
                </div>
                <!--<div class="btnbox">
                    <a class="notice-cancle btn m-yellow">取消</a>
                    <a class="notice-save btn m-green">保存</a>
                </div>-->
                
                <div class="popup m-notice-change">
                    <div class="popup__content" style="width: 600px;">
                        <div class="popup__top">
                            <h2 class="popup__title">修改公告</h2><button type="button" class="popup__close popup__close-btn" onclick="canclePopup(this)">×</button>
                        </div>
                        <div class="popup__detail">
                            <div class="popup__item"><span class="popup__itemname">公告内容</span><input id="notice_detail" type="text" /></div>
                        </div>
                        <div class="popup__btnbox">
                            <a id="notice_change" class="btn m-green m-popup popup-confirm popup__close-btn">确认</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
	
	<script src="{% static 'js/wfl-common.js' %}" type="text/javascript"></script>
    <script type="text/javascript">
    $(function() {
        $('.qqname').val("{{user.qq_name}}");
        $('.qq').val("{{user.qq_number}}");
        $('.tosign').val("{{user.profile}}");
        console.log('{{user.color}}');
        $('.skin__item').removeClass('on');
        $('.skin__item').eq({{user.color}}).addClass('on');
        
        var skin = '';
        var img = '';
        var img2;
        var file_list = [];
        //    用于压缩图片的canvas
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        //    瓦片canvas
        var tCanvas = document.createElement("canvas");
        var tctx = tCanvas.getContext("2d");
        var file;
        var maxsize = 80 * 1024;
        console.log("{{user.picture_url}}");
        var options =
        {
            thumbBox: '.thumbBox',
            spinner: '.spinner',
            imgSrc: "{{user.picture_url}}"
        }
        var cropper = $('.imageBox').cropbox(options);
        $('#upload-file').on('change', function(){
            var reader = new FileReader();
            
            if(!this.files.length) return;
            file = this.files[0];
            console.log(file);
            
            reader.onload = function(e) {
                options.imgSrc = e.target.result;
                cropper = $('.imageBox').cropbox(options);
            }
            reader.readAsDataURL(this.files[0]);
//          this.files = [];
        })
        $('#btnCrop').on('click', function(){
            img2 = cropper.getDataURL();
            $('.cropped').html('');
            $('.cropped').append('<img src="'+img2+'" align="absmiddle" style="width:64px;margin-top:4px;border-radius:64px;box-shadow:0px 0px 12px #7E7E7E;" ><p>64px*64px</p>');
            $('.cropped').append('<img src="'+img2+'" align="absmiddle" style="width:128px;margin-top:4px;border-radius:128px;box-shadow:0px 0px 12px #7E7E7E;"><p>128px*128px</p>');
            $('.cropped').append('<img src="'+img2+'" align="absmiddle" style="width:180px;margin-top:4px;border-radius:180px;box-shadow:0px 0px 12px #7E7E7E;"><p>180px*180px</p>');
            
            var result = img2;
            var img = new Image();
            img.src = result;
//              $(li).css("background-image", "url(" + result + ")");
            //如果图片大小小于100kb，则直接上传
            if(result.length <= maxsize) {
                img = null;
                process(result, file.name, file.type);
                return;
            }
            //      图片加载完毕之后进行压缩，然后上传
            if(img.complete) {
                callback();
            } else {
                img.onload = callback;
            }

            function callback() {
                var data = compress(img);
                process(data, file.name, file.type);
                img = null;
            }
        })
        $('#btnZoomIn').on('click', function(){
            cropper.zoomIn();
        })
        $('#btnZoomOut').on('click', function(){
            cropper.zoomOut();
        })
        
        
        $('.skin__item').click(function(){
            $(this).addClass('on').siblings().removeClass('on');
            skin = $(this).index();
            console.log(skin);
        })
//      头像处理

        //    使用canvas对大图片进行压缩
        function compress(img) {
            var initSize = img.src.length;
            var width = img.width;
            var height = img.height;
            //如果图片大于四百万像素，计算压缩比并将大小压至40万以下
            var ratio;
            if((ratio = width * height / 400000) > 1) {
                ratio = Math.sqrt(ratio);
                width /= ratio;
                height /= ratio;
            } else {
                ratio = 1;
            }
            console.log("ratio:" + ratio);
            canvas.width = width;
            canvas.height = height;
            //        铺底色
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            //如果图片像素大于100万则使用瓦片绘制
            var count;
            if((count = width * height / 1000000) > 1) {
                count = ~~(Math.sqrt(count) + 1); //计算要分成多少块瓦片
                //            计算每块瓦片的宽和高
                var nw = ~~(width / count);
                var nh = ~~(height / count);
                tCanvas.width = nw;
                tCanvas.height = nh;
                for(var i = 0; i < count; i++) {
                    for(var j = 0; j < count; j++) {
                        tctx.drawImage(img, i * nw * ratio, j * nh * ratio, nw * ratio, nh * ratio, 0, 0, nw, nh);
                        ctx.drawImage(tCanvas, i * nw, j * nh, nw, nh);
                    }
                }
            } else {
                ctx.drawImage(img, 0, 0, width, height);
            }
            //进行最小压缩
            var ndata = canvas.toDataURL('image/jpeg', 0.5);
            console.log('压缩前：' + initSize);
            console.log('压缩后：' + ndata.length);
            console.log('压缩率：' + ~~(100 * (initSize - ndata.length) / initSize) + "%");
            tCanvas.width = tCanvas.height = canvas.width = canvas.height = 0;
            return ndata;
        }
        //    图片上传，将base64的图片转成二进制对象，塞进formdata上传
        function process(basestr, name, type, $li) {
            var text = window.atob(basestr.split(",")[1]);
            var buffer = new Uint8Array(text.length);
            for(var i = 0; i < text.length; i++) {
                buffer[i] = text.charCodeAt(i);
            }
            var blob = getBlob([buffer], type);
            file_list.push({
                name:name,
                blob:blob
            });
        }

        function submit(){
            var xhr = new XMLHttpRequest();
            var formdata = new FormData();

            var qqname = $('.qqname').val();
            var qq = $('.qq').val();
            var tosign = $('.tosign').val();
            if (!qq || !qqname) {
                alert('qq号和qq昵称不能为空');
                return;
            }
            
            var detail = 'skin=' + skin + ' qqname=' + qqname + ' qq=' + qq + ' tosign=' + tosign;
            console.log(detail);
            if (file_list.length!=0){
                console.log('add pic');
                formdata.append("picture", file_list[0].blob, file_list[0].name);
            }
            formdata.append('color', skin);
//          formdata.append('picture', file);
            formdata.append('qq_number', qq);
            formdata.append('qq_name', qqname);
            formdata.append('profile', tosign);
            console.log(formdata);
            var userId = {{user.id}};
            xhr.open('put', '/restapi/users/' + userId + '/');
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
//          maskIn();
            xhr.onreadystatechange = function() {
                $(".img-mask").css("display", "none");
                if(xhr.readyState == 4 && xhr.status == 200) {
//                  
//                  $('.qqname').val(qqname);
//                  $('.qq').val(qq);
//                  $('.profile').val(tosign);
                    var ret = JSON.parse(xhr.responseText);
                    if(ret.code == 0) {
                        alert("请先登录！")
//                      return;
                    }else if(ret.code==1){
                        console.log("任务完成，请耐心等待工作人员审核!")
                    }else{
                        console.log(ret.msg)
                    }
                }
            };

            xhr.send(formdata);
        }
        /**
         * 获取blob对象的兼容性写法
         * @param buffer
         * @param format
         * @returns {*}
         */
        function getBlob(buffer, format) {
            try {
                return new Blob(buffer, {
                    type: format
                });
            } catch(e) {
                var bb = new(window.BlobBuilder || window.WebKitBlobBuilder || window.MSBlobBuilder);
                buffer.forEach(function(buf) {
                    bb.append(buf);
                });
                return bb.getBlob(format);
            }
        }
        
//      头像处理---end
        $('.save').click(function(){
            submit();
        })
        $('.cancle').click(function(){
            var notice_arr = [111,222,333,444,555];
            $('.userimg').css('background-image', 'url(../../static/images/about03.png)');
            $('.skin__item').removeClass('on');
            $($('.skin__item')[0]).addClass('on');
            $('.qqname').val('nothing');
            $('.qq').val('342534543');
            $('.tosign').val('阿萨德回家看');
        })
        
    })
    
    $.ajax({
        url: '/restapi/notice/',
        dataType:"json",
        type:'get',
        success:function(ret){
            console.log(ret.results);
            var notice_html = "";
            for (var i=0; i<ret.results.length; i++) {
                notice_html += '<li class="notice-item"><span class="notice-text">' + ret.results[i].content + '</span>' + 
                '<span class="notice-change" onclick="noticeChange(this,' + ret.results[i].id + ')">修改</span>' +
                '<span class="notice-delete" onclick="noticeDelete(this,' + ret.results[i].id + ')">删除</span></li>';
            }
            $('.notice-exist').html(notice_html);
        },
        error:function(){
            console.log("请检查网络连接");
        }
    });
    
    
    $('.notice-add').click(function(){
        var content = $('.notice').val();
        console.log(content);
        if ($('.notice-item').length >= 10) {
            alert('最多添加十条公告');
            return;
        }
        if (!content) {
            alert('请输入通知内容');
            return;
        }
        $.ajax({
            url: '/restapi/notice/',
            dataType:"json",
            type:'post',
            data : {
                'content':content,
            },
            success:function(ret){
                alert('添加公告成功');
                var notice_html = '<li class="notice-item"><span class="notice-text">' + ret.content + '</span>' + 
                '<span class="notice-change" onclick="noticeChange(this,' + ret.id + ')">修改</span>' +
                '<span class="notice-delete" onclick="noticeDelete(this,' + ret.id + ')">删除</span></li>';
                $('.notice-exist').append(notice_html);
            },
            error:function(){
                alert("请检查网络连接");
            }
        });
    })
    var notice_item;
    var notice_id;
    function noticeChange(obj,id) {
        notice_id = id;
        notice_item = $(obj).parent().find('.notice-text');
        var notice_txt = notice_item.text();
        $('#notice_detail').val(notice_txt);
        $('.popup.m-notice-change').addClass('in');
    }
    $('#notice_change').click(function(){
        var content = $('#notice_detail').val();
        console.log(content);
        $.ajax({
            url: '/restapi/notice/' + notice_id + '/',
            dataType:"json",
            type:'put',
            data : {
                'content':content,
            },
            success:function(ret){
                notice_item.html(content);
                $('.popup.m-notice-change').removeClass('in');
            },
            error:function(){
                console.log("请检查网络连接");
            }
        });
    })
    function noticeDelete(obj,id) {
        console.log(id);
        $.ajax({
            url: '/restapi/notice/' + id + '/',
            dataType:"json",
            type:'delete',
            success:function(ret){
                $(obj).parent().remove();
            },
            error:function(){
                console.log("请检查网络连接");
            }
        });
    }
    </script>
</body>
</html>
