{% load staticfiles %}
<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<title>收支详情</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link href="{% static 'css/mui.min.css' %}" rel="stylesheet" />
	<link rel="stylesheet" href="{% static 'css/m_hongbao.css' %}" />
	<script type="text/javascript" src="{% static 'js/rem.js' %}"></script>
	<style>
		.mui-bar-nav~.mui-content {
			padding-top: 0;
		}

		.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
			color: #90c01e;
			border-bottom: 2px solid #90c01e;
			background: 0 0;
		}

		.mui-active {
			background: white !important;
		}
	</style>
</head>

<body>
	<header class="mui-bar mui-bar-nav" style="position: relative;background: white;">
		<a href="{% url 'account_index' %}" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: #656565;"></a>
		<h1 class="mui-title" style=" color: RGB(102,102,102);">我的红包</h1>
	</header>
	<div class="mui-content">
		<!-- 红包模态框 -->
		<div class="modal_box">
			<div class="modal_img_box">
				<div class="modal_amount_box">
					<div class="modal_amount">
						
					</div>
					<div class="modal_desc">
						以存放至账户余额
					</div>
				</div>
				<div class="modal_btn">确定</div>
			</div>
		</div>
		<!--选项卡部分-->
		<div id="finance_slider" class="mui-slider mui-fullscreen">
			<div class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
				<a class="mui-control-item" href="#item1">可用红包（10）</a>
				<a class="mui-control-item" href="#item2">失效红包（10）</a>
			</div>
			<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6" style="background: #90c01e;"></div>
			<div class="mui-slider-group">
				<div id="item1" class="mui-slider-item mui-control-content mui-active" value="1">
					<div id="scroll1" class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view tab1">
								
							</ul>
						</div>
					</div>
				</div>
				<!-- 失效红包 -->
				<div id="item2" class="mui-slider-item mui-control-content" value="2">
					<div id="scroll1" class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view tab2">
								
							</ul>
						</div>
					</div>
				</div>

			</div>

		</div>

	</div>
	<!-- <div id="pullrefresh" class="mui-scroll-wrapper" style="top:32px;">
			<div class="mui-content">
				<ul class="mui-table-view">
					
				</ul>
			</div>
		</div> -->
	{% include "m_footer.html" %}
	<script src="{% static 'js/mui.min.js' %}"></script>
	<script src="{%static 'js/mui.pullToRefresh.js'%}"></script>
	<script src="{%static 'js/mui.pullToRefresh.material.js'%}"></script>
	<script type="text/javascript">
		mui.init();
		//初始化滚动条
		mui('.mui-scroll-wrapper').scroll({
			deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
		});
		//ajax获取红包列表数据：
		var html1 = document.querySelector(".tab1");
		var html2 = document.querySelector(".tab2");
		mui.ajax('/coupon/coupons/?' + "user={{user.id}}", {
				dataType: 'json', //服务器返回json格式数据 
				type: 'get', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				//headers:{'Content-Type':'application/json'},
				success: function (data) {
					console.log("data:",data);
					for(var i in data.results){
						var span = document.createElement("span");
						var li = document.createElement("li");
						li.className = "mui-table-view-cell";
						if(data.results[i].is_expired === false){
							str_html = '<div class="hongbao_box" data-id="'+ data.results[i].id +'">' +
											'<div class="hongbao_top">' +
												'<div class="amount">' +
													'<span>￥</span>' +
													'<span class="amount1 useable">'+ data.results[i].award +'</span>' +
												'</div>' +
												'<div class="time">' +
													'<span>有效期至：</span>' +
													'<span>'+ data.results[i].expire +'</span>' +
												'</div>' +
												'<button type="button" data-award="'+ data.results[i].award +'" data-id="'+ data.results[i].id +'" class="mui-btn take take'+ data.results[i].is_to_expired +' mui-btn-outlined">'+ data.results[i].state_des +'</button>' +
											'</div>' +
											'<div class="hongbao_bottom">' +
												'<span class="btm_text">'+ data.results[i].type_des +'</span>' +
											'</div>' +
										'</div>'
								li.innerHTML = str_html;
								html1.appendChild(li);
						}else{
							str_html = '<div class="hongbao_box">' +
											'<div class="fhongbao_top">' +
													'<div class="amount fail">' +
													'<span>￥</span>' +
													'<span class="amount1">'+ data.results[i].award +'</span>' +
												'</div>' +
												'<div class="time fail">' +
													'<span>有效期至：</span>' +
													'<span>'+ data.results[i].expire +'</span>' +
												'</div>' +
												'<div class="failBox"></div>' +
											'</div>' +
											'<div class="hongbao_bottom">' +
												'<span class="btm_text">'+ data.results[i].type_des +'</span>' +
											'</div>' +
										'</div>'
							li.innerHTML = str_html;
							html2.appendChild(li);
						}
					}
				},
				error: function (xhr, type, errorThrown) {
					console.log(xhr.responseText);
				}
			});
			
			//领取点击事件ajax:
			var modal_box = document.querySelector(".modal_box");
			var modal_amount = document.querySelector(".modal_amount");
			mui(document).on("tap",".take",function () { //加载出来的button DOM节点 用on监听
				console.log(mui(this));
				var award = mui(this)[0].getAttribute("data-award"); //获取button的data-award属性
				modal_amount.innerHTML = award;
				var hongbaoId = mui(this)[0].getAttribute("data-id");
				//领取红包ajax
				mui.ajax('/coupon/open_coupon/', {
					dataType: 'json', //服务器返回json格式数据 
					type: 'post', //HTTP请求类型
					data:{
						id:hongbaoId
					},
					timeout: 10000, //超时时间设置为10秒；
					//headers:{'Content-Type':'application/json'},
					success: function (data) {
						if(data.code == 0){
							modal_box.style.display = "block";
							mui(this).innerHTML = "已领取";
							// mui(this).style.backgroundColor = "#c7c7c7";
						}
					},
					error: function (xhr, type, errorThrown) {
						console.log(xhr.responseText);
					}
			});
				
			});
			//隐藏模态框：
			var modal_btn = document.querySelector(".modal_btn");
			modal_btn.onclick = function () { 
				modal_box.style.display = "none";
			}
		
	</script>
</body>

</html>