{% load staticfiles %}
<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>个人中心</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />

		<link rel="stylesheet" href="{% static 'css/mui.min.css' %}" />
		<!--<link rel="stylesheet" href="dist/css/User.css" />-->
		<!--<link rel="stylesheet" href="{% static 'css/m_account_index.css' %}" />-->
		<!--<link rel="stylesheet" href="dist/css/iconfont.css" />-->
		<link rel="stylesheet" href="{% static 'css/iconfont.css' %}" />
		<!--<script type="text/javascript" src="dist/js/rem.js" ></script>-->
		<script type="text/javascript" src="{% static 'js/rem.js' %}"></script>
		<script type="text/javascript" src="{% static 'js/clipboard.min.js' %}"></script>
		<style type="text/css">
			body {
				font-size: 1.2rem;
			}
			
			li {
				list-style: none;
			}
			
			ul,
			li,
			p {
				margin: 0;
				padding: 0;
			}
			
			.mui-content {
				padding-bottom: 60px;
			}
			
			.top {
				background: RGB(145, 193, 29);
				position: relative;
				height: 20.5rem;
				width: 100%;
			}
			
			.headerPic {
				width: 9rem;
				height: 9rem;
				border-radius: 100%;
				background: blue;
				position: absolute;
				left: 11rem;
				top: 2rem;
			}
			
			.headerPic>img {
				width: 100%;
				height: 100%;
				border-radius: 100%;
				overflow: hidden;
			}
			
			.phone_num {
				margin-left: 1rem;
				color: white;
			}
			
			.left_btm {
				position: absolute;
				bottom: 0;
				left: 2rem;
			}
			
			.right_btm {
				position: absolute;
				bottom: 0;
				right: 2rem;
			}
			
			.top p {
				color: white;
			}
			/*底部导航部分*/
			
			footer {
				width: 100%;
				height: 45px;
				position: fixed;
				bottom: 0;
				font-size: 0;
				background: #fff;
				z-index: 1000;
				border-top: 1px solid #e4e4e4;
			}
			
			footer .footer__item {
				width: 33.3333%;
				display: inline-block;
				font-size: 0;
				text-align: center;
				position: relative;
			}
			
			footer .mui-icon {
				font-size: 22px;
				color: #8f8f8f;
			}
			
			.on .mui-icon {
				color: #91C11D;
			}
			
			.footer__txt {
				display: block;
				margin-top: -6px;
				font-size: 14px;
				color: #4d4d4d;
				line-height: 20px;
			}
			
			.on .footer__txt {
				color: #91C11D;
			}
			
			.outbtn {
				width: 16rem;
				height: 3rem;
				background: RGB(221, 82, 77);
				margin:1rem auto;
				color:white;
				text-align: center;
				line-height: 3rem;
			}
			.mui-popup-text {
			    text-align: left;
			}
			.left_tip_num {
                position: absolute;
                right: 30px;
                top: 14px;
                width: 16px;
                height: 16px;
                line-height: 16px;
                text-align: center;
                background-color: red;
                color: #fff;
                border-radius: 50%;
                font-size: 12px;
            }
		</style>
	</head>

	<body>
		<div class="top">
			<div class="headerPic">
				<!--<img src="img/userPic.jpg" />-->
				<img src="{{user.picture_url}}" />
				<span class="phone_num">{{user.mobile}}</span>
			</div>
			<div class="left_btm">
				<p>{{user.accu_income}}</p>
				<p>积累收益(元)</p>
			</div>
			<div class="right_btm">
				<p>{{user.balance}}</p>
				<p>账户余额(元)</p>
			</div>
		</div>
		<div class="mui-content">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" style="position: relative;">
					<a class="Alink" id="Alink" href="http://{{user.domain_name}}.51fanshu.com" style="color: RGB(102,102,102);">我的主页：http://{{user.domain_name}}.51fanshu.com</a>
					<a id="fenxiang" class="mui-icon iconfont icon-fenxiang" style="position: absolute;top: 1.2rem;right: 1rem;"></a>
				</li>
				<li class="mui-table-view-cell">
					<a id="project" href="{% url 'project_manage' %}" class="mui-navigate-right" style="color: RGB(102,102,102);">项目管理</a>
				</li>
			</ul>
			<ul class="mui-table-view" style="margin-top: 0.5rem;">
				<li class="mui-table-view-cell">
					<!--<a href="http://{{user.domain_name}}.51fanshu.com/quick-submit/" class="mui-navigate-right" style="color: RGB(102,102,102);">自助交单</a>-->
					<a href="{%url 'quick_submit'%}" class="mui-navigate-right" style="color: RGB(102,102,102);">自助交单</a>
				</li>
				<li class="mui-table-view-cell">
					<a href="{%url 'account_audited'%}" class="mui-navigate-right" style="color: RGB(102,102,102);">数据审核</a>
				</li>
				<!-- <li class="mui-table-view-cell">
					<a href="#" class="mui-navigate-right" style="color: RGB(102,102,102);">预约管理</a>
				</li> -->
			</ul>
			<ul class="mui-table-view" style="margin-top: 0.5rem;">
				<li class="mui-table-view-cell">
					<a href="{% url 'account_money' %}" class="mui-navigate-right" style="color: RGB(102,102,102);">收支详情</a>
				</li>
				<li class="mui-table-view-cell">
                    <a href="{% url 'account_withdraw' %}" class="mui-navigate-right" style="color: RGB(102,102,102);">提现</a>
                </li>
                <li class="mui-table-view-cell">
                    <a href="{% url 'account_hongbao' %}" class="mui-navigate-right" style="color: RGB(102,102,102);">我的红包</a>
                    <span style="display: none;" class="left_tip_num" id="coupon_num"></span>
                </li>
        <li class="mui-table-view-cell">
            <a href="/account/message/" class="mui-navigate-right" style="color: RGB(102,102,102);">消息中心</a>
            <span style="display: none;" class="left_tip_num" id="coupon_num"></span>
        </li>
			</ul>
			<div id="out" class="outbtn">
				退出账户
			</div>
		</div>
		<footer>
			<ul>
				<li class="footer__item">
					<a href="{%url 'index'%}">
						<i class="mui-icon mui-icon-home"></i>
						<span class="footer__txt">首页</span>
					</a>
				</li>
				<li class="footer__item">
                    <a href="{%url 'project_all'%}">
                    <i class="mui-icon mui-icon-more"></i>
                    <span class="footer__txt">项目库</span>
                    </a>
                </li>
				<li class="footer__item on">
					<a href="{%url 'account_index'%}">
						<i class="mui-icon mui-icon-person"></i>
						<span class="footer__txt">个人中心</span>
					</a>
				</li>
			</ul>
		</footer>
        {% include "m_footer.html" %}
		<script src="{% static 'js/mui.min.js' %}"></script>
		<script type="text/javascript">
			mui.init();
//			弹窗提示置顶消息部分
            var notice_flag = 0;
            var notice_top = '';
            var date = new Date();
            var now_time = date.getTime();
            function saveCookie() {
                var date = new Date();
                //  date.setDate(date.getDate()+1);
                date.setTime(date.getTime() + 1 * (24 * 60 * 60 * 1000));
                //将cookie保存1天
                setCookie("first_time", now_time, date.toUTCString(), "", "", "");
            }
        
            function setCookie(name, value, expires, path, domain, secure) {
                document.cookie = name + "=" + encodeURI(value) +
                    ((expires) ? "; expires=" + expires : "") +
                    ((path) ? "; path=" + path : "") +
                    ((domain) ? "; domain=" + domain : "") +
                    ((secure) ? "; secure=" + secure : "");
            }
        
            function getCookie(cName) {
                var cookieString = decodeURI(document.cookie);
                var cookieArray = cookieString.split("; ");
                for(var i = 0; i < cookieArray.length; i++) {
                    var cookieNum = cookieArray[i].split("=");
                    var cookieName = cookieNum[0];
                    var cookieValue = cookieNum[1];
        
                    if(cookieName == cName) {
                        return cookieValue;
                    }
                }
                return false;
            }
            //删除Cookie就是简单的将cookie的expires属性设置为一个过去的时间即可。
            function deleteCookie() {
                var date = new Date();
                date.setTime(date.getTime() - 1000);
                setCookie("first_time", date.getTime(), date.toUTCString(), "", "", "");
            }
        
        
            
            var con1 = document.getElementById('con1');
            var notice_txt = '';
            mui.ajax('/restapi/announcement/?ordering=state', {
                dataType: 'json', //服务器返回json格式数据
                type: 'get', //HTTP请求类型
                timeout: 3000, //超时时间设置为10秒；
                success: function(ret) {
                    if (ret.results.length != 0){
                        var notice_num = 1;
                        var notice_popup_num = 1;
//                      deleteCookie();
                        
                        var first_time = getCookie('first_time');
                        date.setTime(first_time);
                        var date_cookie = date.getFullYear() + '-' + date.getMonth() + '-' + date.getDate();
                        date.setTime(now_time);
                        var date_now = date.getFullYear() + '-' + date.getMonth() + '-' + date.getDate();
                        console.log(date_cookie);
                        console.log(date_now);
                        if (first_time && date_now == date_cookie) {
                            console.log('已有');
                            notice_flag = 0;
                        } else{
                            console.log('还未');
                            saveCookie();
                            notice_flag = 1;
                        }
                        
                        for (var i in ret.results) {
                            if (ret.results[i].state == 0) {
                                notice_top += '<p><span>'+ (notice_popup_num++) +'、</span>' + ret.results[i].content +'</p>';
                            }
                        }
                        if (notice_flag == 1 && notice_top != '') {
                            mui.alert(notice_top,'重要通知');
                        }
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR.responseText);
                    mui.alert("数据错误");
                }

            });
            
//          置顶消息----------end
            mui.ajax('/coupon/get_coupon_num/', {
                dataType: 'json', //服务器返回json格式数据
                type: 'get', //HTTP请求类型
                timeout: 3000, //超时时间设置为10秒；
                success: function(ret) {
                    console.log(ret.count);
                    if (ret.count > 0) {
                    	document.getElementById('coupon_num').innerText = ret.count;
                    	document.getElementById('coupon_num').style.display = 'block';
                    } else{
                    	document.getElementById('coupon_num').style.display = 'none';
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR.responseText);
                    mui.alert("数据错误");
                }

            });

			var hUrl = document.getElementById("Alink").getAttribute("href");
			console.log(hUrl);
			mui('.mui-table-view-cell').on('tap', '.Alink', function() {
				mui.openWindow({
					url: hUrl,
					styles: {
						top: 0,
						bottom: 0
					},
					show: {
						aniShow: 'slide-in-right',
					},
					waiting: {
						autoShow: false, //自动显示等待框
						title: '正在加载...', //等待对话框上显示的提示内容
					}
				});
			});

			mui('.mui-table-view-cell').on('tap', '.mui-navigate-right', function() {
				var pUrl = this.getAttribute("href");
				mui.openWindow({
					url: pUrl,
					styles: {
						top: 0,
						bottom: 0
					},
					show: {
						aniShow: 'slide-in-right',
					},
					waiting: {
						autoShow: false, //自动显示等待框
						title: '正在加载...', //等待对话框上显示的提示内容
					}
				});
			});

			//点击icon复制链接
			var clipboard = new Clipboard("#fenxiang", {
				text: function() {
					return 'http://{{user.domain_name}}.51fanshu.com';
				}
			});
			//组织事件冒泡
			document.getElementById("fenxiang").addEventListener('tap',function(){
				event.stopPropagation();
//				mui.alert("点击了分享按钮");
			});
			
			clipboard.on('success', function(e) {
				mui.alert("分享链接复制成功");
				console.log(e);
			});
			clipboard.on('error', function(e) {
				console.log(e);
			});

			//点击退出
			document.getElementById("out").addEventListener("tap", function() {
				var btnArray = ['确定退出', '取消'];
				mui.confirm('您确定要退出账户吗？', "提示", btnArray, function(e) {
					if(e.index == 1) {
						return;
					} else {
						mui.openWindow({
							url: '{% url "logout" %}'
						});
					}
				});
			});
		</script>
	</body>

</html>