{% extends "base.html" %}
{% block js %}
<script type="text/javascript">
$.ajaxSetup({
    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
});
var data = '<table width="100%"><tr><th>渠道等级</th><th>QQ</th><th>QQ昵称</th><th>手机号</th>'+
	'<th>银行卡号</th><th>持卡人姓名</th><th>加入时间</th><th>账户余额</th>'+
	'<th width="5%">是否为黑名单</th><th>账户操作</th>'+
	'</tr>[results]<tr><td>{level}</td><td>{qq_number}</td><td>{qq_name}</td>'+
	'<td>{mobile}</td><td>{card_number}</td><td>{bank}</td><td>{date_joined}</td>'+
	'<td>{balance}</td><td class="black" id="is_black_{id}">{is_active}</td>'+
	'<td id="item_{id}"><a class="btn1-x" onclick="addcash({id})">余额</a>│'+
	'<a class="btn2-x black_btn" data-isblack="{is_active}" id="black_{id}" onclick="addblack({id})">加黑</a>'+
	'</td></tr>[/results]</table>';
var url = "/restapi/users/" + "?page={page}&pageSize={pageSize}";
var selected_id = 0;
function pagecallback() {
    $('.black').each(function() {
        if ($(this).text() == "false") {
            $(this).text("是");
        } else {
           $(this).text("否"); 
        }
    })
    $('.black_btn').each(function() {
        if ($(this).data('isblack') == false) {
            $(this).text("去黑");
        } else {
            $(this).text("加黑");
        }
    })
}

function addcash(id){
	$(".Balance").css("display","block");
	selected_id = id;
}
function addblack(id){
	selected_id = id;
	var opertype=$("a#black_"+id).html();
	if(opertype == "加黑"){
		$(".Blacklist").css("display","block");
	}
	else {
		$(".Blacklist-none").css("display","block");
	}
}

$(document).ready(function(){
	$("li.home2").toggleClass("on");
	$(".Tin-table-box tr:even").css("background-color","#fcfcfc");
	$("#pagedata").ajaxPage({
	    url:url+"&state=0",
	    pageId:$("#page"),
	    pageSize:10,
	    run:true,
	    content:data,
	    complete:pagecallback,
	});
	$(".none-x").click(function(){
		$(this).parent().parent().css("display","none");<!--隐藏-->
	})
	$(".none-x-s").click(function(){
		$(this).parent().parent().parent().parent().css("display","none");<!--隐藏-->
	})
	$('.Balance input[type="submit"]').click(function(){
		id = selected_id;
		pcash = $("input#plus_balance").val();
		mcash = $("input#minus_balance").val();
		reason = $("#balance_reason").val();
		if (!id || !pcash && !mcash ||!reason){
			return;
		}
		if (pcash && mcash){
			alert("不能同时添加和扣减余额");
			return;
		}
		$.ajax({
			url:"{%url 'admin_user' %}",
			dataType:"json",
			type:"POST",
			data:{
				'id':id,
				'pcash':pcash,
				'mcash':mcash,
				'reason':reason,
				'type':1,
			},
			success:function(ret){
				if(ret.code==0){
					alert("操作成功！");
				} else {
					alert(ret.res_msg);
				}
			},
			error:function(){
				alert("请检查网络连接");
			}
		});
		$(".Balance").css("display","none");
	});
	$('.Blacklist input[type="submit"]').click(function(){
		id = selected_id;
		if (!id){
			return;
		}
		$.ajax({
			url:"{%url 'admin_user' %}",
			dataType:"json",
			type:"POST",
			data:{
				'id':id,
				'type': 2,
			},
			success:function(ret){
				if(ret.code==0){
					alert("操作成功！");
				} else {
					alert(ret.res_msg);
				}
			},
			error:function(){
				alert("请检查网络连接");
			}
		});
		$("a#black_"+selected_id).html("去黑");
		$("td#is_black_"+selected_id).html("是");
		$(".Blacklist").css("display","none");
	});
	$('.Blacklist-none input[type="submit"]').click(function(){
		id = selected_id;
		if (!id){
			return;
		}
		$.ajax({
			url:"{%url 'admin_user' %}",
			dataType:"json",
			type:"POST",
			data:{
				'id':id,
				'type':3,
			},
			success:function(ret){
				if(ret.code==0){
					alert("操作成功！");
				} else {
					alert(ret.res_msg);
				}
			},
			error:function(){
				alert("请检查网络连接");
			}
		});
		$("a#black_"+selected_id).html("加黑");
		$("td#is_black_"+selected_id).html("否");
		$(".Blacklist-none").css("display","none");
	});

	$("#search").click(function(){
		var startTime = $("#startTime").val();
		var endTime = $("#endTime").val();
		var newurl = url;
		if(startTime && endTime){
			newurl += "&join_date_0="+startTime;
			newurl += "&join_date_1="+endTime;
		}
		var qq = $("#qq").val();
		var qqname = $("#qqname").val();
		if(qq){
			newurl += "&qq_number="+qq;
		}
		if(qqname){
			newurl += "&qq_name="+qqname;
		}
		var level = $("#level").val();
		if(level){
			newurl += "&level="+level;
		}
		var state = $("#state").val();
		if(state){
			newurl += "&is_active="+state;
		}
		var newdata = data;
		$("#page").empty();
		$("#pagedata").ajaxPage({
		    url:newurl,
		    pageId:$("#page"),
		    pageSize:10,
		    run:true,
		    content:newdata,
		    complete:pagecallback,
		});
	});
	$("#export").click(function() {
        var html = '<form action="' + "export_finance_excel" + '" method="get" target="_self" id="postData_form">';
        var startTime = $("#startTime").val(),
            endTime = $("#endTime").val(),
            qq = $("#qq").val(),
            qqname = $("#qqname").val(),
            level = $("#level").val(),
            state = $("#state").val();
            
        if(startTime && endTime) {
            html += '<input name="join_date_0" type="hidden" value="' + startTime + '"/>';
            html += '<input name="join_date_1" type="hidden" value="' + endTime + '"/>';
        }
        if(qq) {
            html += '<input name="qq_number" type="hidden" value="' + qq + '"/>';
        }
        if(qqname) {
            html += '<input name="qq_name" type="hidden" value="' + qqname + '"/>';
        }
        if(level) {
            html += '<input name="level" type="hidden" value="' + level + '"/>';
        }
        if(state) {
            html += '<input name="is_active" type="hidden" value="' + state + '"/>';
        }
        
        html += '</form>';
        var iframe = document.getElementById('myIFrame');
        iframe.contentWindow.document.open();
        iframe.contentWindow.document.write(html);
        iframe.contentWindow.document.close();
        document.getElementById('myIFrame').contentWindow.document.getElementById('postData_form').submit();
    });
});
</script>
{% endblock js %}

{% block right %}
<div class="Criteria">
	<span>搜索条件</span>
    <div class="Crite-box">
    	<form>
        	<table width="100%">
            	<tr>
                	<td>
                    	<i>加入开始时间：</i>
                        <input id="startTime" type="datetime-local" />
                    </td>
                	<td>
                    	<i>加入结束时间：</i>
                        <input id="endTime" type="datetime-local" />
                    </td>
                	
                	<td>
                    	<i>QQ：</i>
                        <input id="qq" type="text" />
                    </td>
                	<td>
                    	<i style="letter-spacing:2px;">QQ昵称：</i>
                        <input id="qqname" type="text" />
                    </td>
                </tr>
            	<tr>
                	<td>
                    	<i>渠道等级：</i>
                        <select name="selectAge" id="level">
                            <option value="">--</option>
                            <option value="01">01</option>
                            <option value="02">02</option>
                            <option value="03">03</option>
                        </select>
                    </td>
                	<td>
                    	<i>黑&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;单：</i>
                        <select name="selectAge" id="state">
					        <option value="">全部</option>
					        <option value="false">是</option>
					        <option value="true">否</option>
					    </select>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                	<td>
                    	<div class="Submit-box">
                            <input id="search" type="button" value="搜索" />
                			<input id="export" type="button" value="导出" />
                        </div>
                    </td>
                </tr>
            </table>

        </form>
    </div>
</div>
<div class="Tin-table">
	<div id="pagedata">
	</div>
    <div class="Page-in-admin">
    	<div class="page"  id="page">
        </div>
    </div>
</div>
<iframe id="myIFrame" scrolling="yes" src="abount:blank" style="display:none" frameborder=1></iframe>
{%endblock%}
{% block modal %}
<!--余额操作-->
    <div class="Balance">
    	<div class="w570-box">
        	<h3>余额操作</h3>
            <button class="none-x"></button>
            <form class="Finnow">
            	<span>添加余额：</span>
                <input id="plus_balance" type="text" />
                <span>消减余额：</span>
                <input id="minus_balance" type="text" />
                <div class="Balance-in">
                    <span>原因备注：</span>
                    <textarea id="balance_reason"></textarea>
                </div>
                <div class="Finnow-Sub">
                <input type="submit" value="确认" onclick="return false;"/>
                <input type="button" value="取消" class="none-x-s" />
                </div>
            </form>
        </div>
    </div>
    <!--确认加黑-->
    <div class="Blacklist">
    	<div class="w570-box">
        	<h3>黑名单操作</h3>
            <button class="none-x"></button>
            <h5 style="font-size: 20px"> 确认加黑？</h5>
            <form class="Audit-in">
                <div class="Finnow-Sub" style="margin-top:0">
                <input type="submit" value="确认" onclick="return false;"/>
                <input type="button" value="取消" class="none-x-s" />
                </div>
            </form>
        </div>
    </div>
    <!--取消确认加黑-->
    <div class="Blacklist-none">
    	<div class="w570-box">
        	<h3>黑名单操作</h3>
            <button class="none-x"></button>
            <h5> 确认取消加黑？</h5>
            <form class="Audit-in">
                <div class="Finnow-Sub" style="margin-top:0">
                <input type="submit" value="确认" onclick="return false;"/>
                <input type="button" value="取消" class="none-x-s" />
                </div>
            </form>
        </div>
    </div>
  {%endblock%}
